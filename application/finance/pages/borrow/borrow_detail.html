<!DOCTYPE html>
<html>
    <head>
        <link rel="import" href="/pages/common/title.html?__inline" >
        <!-- Tell the browser to be responsive to screen width -->
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
        <!-- Bootstrap 3.3.6 -->
        <link rel="stylesheet" href="../../bootstrap/css/bootstrap.min.css">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <!-- Ionicons -->
        <link rel="stylesheet" href="//cdn.bootcss.com/ionicons/2.0.1/css/ionicons.min.css">
        <!-- daterange picker -->
        <link rel="stylesheet" href="../../plugins/datepicker/datepicker3.css">
        <!-- DataTables -->
        <link rel="stylesheet" href="../../plugins/datatables/dataTables.bootstrap.css">
        <!-- Theme style -->
        <link rel="stylesheet" href="../../dist/css/AdminLTE.min.css">
        <!-- AdminLTE Skins. Choose a skin from the css/skins
             folder instead of downloading all of them to reduce the load. -->
        <link rel="stylesheet" href="../../dist/css/skins/_all-skins.min.css">
        <link rel="stylesheet" href="../../plugins/imgviewer/viewer.min.css">
        <link rel="import" href="../common/template_upload_css.html?__inline" >

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body class="hold-transition skin-blue sidebar-mini">
        <div class="wrapper">

            <link rel="import" href="../common/header.html?__inline" >
            <!-- Left side column. contains the logo and sidebar -->
            <link rel="import" href="../common/left.html?__inline" >

            <!-- Content Wrapper. Contains page content -->
            <div class="content-wrapper">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>
                        融资单详情
                        <small>borrow detail</small>
                    </h1>
                    <ol class="breadcrumb">
                        <li><a href="/index.html"><i class="fa fa-dashboard"></i> 首页</a></li>
                        <li><a href="/pages/borrow/borrow_lists.html">融资记录</a></li>
                        <li class="active">融资单详情</li>
                    </ol>
                </section>

                <!-- Main content -->
                <section class="content">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="box">
                                <div class="box-body">
                                    <div class="form-group">
                                        <label>合同编号：</label>
                                        <span style="padding-left:10px;padding-right: 10px;" id="bill_sn"></span>
                                        <a href="#" class="btn btn-default btn-xs">查看合同</a>
                                    </div>
                                    <div class="form-group">
                                        <label>融资企业：</label>
                                        <span style="padding-left:10px;" id="company"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>收款账户：</label>
                                        <span style="padding-left:10px;" id="account"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>融资金额：</label>
                                        <span style="padding-left:10px;" id="money"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>项目内容：</label>
                                        <span style="padding-left:10px;" id="content"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>打款时间：</label>
                                        <span style="padding-left:10px;" id="paid_time"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>打款凭证：</label>
                                        <form id="payment_certificate" action="//jquery-file-upload.appspot.com/" method="POST" enctype="multipart/form-data">
                                            <!-- The table listing the files available for upload/download -->
                                            <table role="presentation" class="table table-striped"><tbody class="files"></tbody></table>
                                            <!-- Redirect browsers with JavaScript disabled to the origin page -->
                                            <noscript><input type="hidden" name="redirect" value="https://blueimp.github.io/jQuery-File-Upload/"></noscript>
                                            <!-- The fileupload-buttonbar contains buttons to add/delete files and start/cancel the upload -->
                                            <div class="row fileupload-buttonbar">
                                                
                                            </div>
                                        </form>
                                    </div>
                                    <div class="form-group">
                                        <label>用户资料（压缩包）</label>
                                        <form id="attach" action="//jquery-file-upload.appspot.com/" method="POST" enctype="multipart/form-data">
                                            <!-- The table listing the files available for upload/download -->
                                            <table role="presentation" class="table table-striped"><tbody class="files"></tbody></table>
                                            <!-- Redirect browsers with JavaScript disabled to the origin page -->
                                            <noscript><input type="hidden" name="redirect" value="https://blueimp.github.io/jQuery-File-Upload/"></noscript>
                                            <!-- The fileupload-buttonbar contains buttons to add/delete files and start/cancel the upload -->
                                            <div class="row fileupload-buttonbar">
                                                <div class="col-lg-3">
                                                    <!-- The fileinput-button span is used to style the file input field as button -->
                                                    <span class="btn btn-success fileinput-button">
                                                        <i class="glyphicon glyphicon-plus"></i>
                                                        <span>添加...</span>
                                                        <input type="file" name="file">
                                                    </span>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="form-group">
                                        <label>资料完整情况说明：</label>
                                        <textarea class="form-control" name="user_remark" rows="3" placeholder="" disabled="disabled"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>风控审核意见：</label>
                                        <textarea class="form-control" name="remark" rows="3" placeholder="" disabled="disabled"></textarea>
                                    </div>
                                </div>
                                <div class="box-footer">
                                    <button type="submit" class="btn btn-primary margin" data-added="2">保存（未补全）</button>
                                    <button type="submit" class="btn btn-success margin" data-added="1">保存（已补全）</button>
                                    <a class="btn btn-default margin" href="javascript:;" onclick="history.go(-1);">取消</a>
                                </div>
                                <div class="box-footer">
                                    <a href="" class="btn btn-warning margin">去修改</a>
                                    <a class="btn btn-default margin" href="javascript:;" onclick="history.go(-1);">取消</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- The time line -->
                            <ul class="timeline">
                            </ul>
                        </div>
                        <!-- /.col -->
                    </div>
                    <!-- /.row -->
                </section>
                <!-- /.content -->
                <!-- Modal -->
                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Modal title</h4>
                            </div>
                            <div class="modal-body">
                                ...
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.content-wrapper -->
            <link rel="import" href="../common/footer.html?__inline" >

            <!-- Control Sidebar -->
            <link rel="import" href="../common/control_sidebar.html?__inline" >
            <!-- /.control-sidebar -->
        </div>
        <!-- ./wrapper -->
        <link rel="import" href="../common/template_upload.html?__inline" >
        <!-- jQuery 2.2.3 -->
        <script src="../../plugins/jQuery/jquery-2.2.3.min.js"></script>
        <!-- Bootstrap 3.3.6 -->
        <script src="../../bootstrap/js/bootstrap.min.js"></script>
        <!-- SlimScroll -->
        <script src="../../plugins/slimScroll/jquery.slimscroll.min.js"></script>
        <!-- FastClick -->
        <script src="../../plugins/fastclick/fastclick.js"></script>
        <!-- AdminLTE App -->
        <script src="../../dist/js/app.min.js"></script>
        <!-- AdminLTE for demo purposes -->
        <script src="../../dist/js/demo.js"></script>
        <script src="../../plugins/moment/moment.min.js"></script>
        <script src="../../plugins/datepicker/bootstrap-datepicker.js"></script>
        <script src="../../plugins/imgviewer/viewer.min.js"></script>
        <link rel="import" href="../common/template_upload_js.html?__inline" >
        <!-- page script -->
        <script>
            $(function () {
                var token = USER.get_token();
                var set_value = function(data){
                    $('#bill_sn').text(data.bill_sn);
                    $('#company').text(data.company);
                    $('#account').text(data.pay_account);
                    $('#money').text(Math.floor(data.money/100));
                    $('textarea[name=user_remark]').val(data.user_remark);
                    $('textarea[name=remark]').val(data.verify_remark);
                    $('#content').html('客户<font class="text-yellow">'+data.name+'</font>购买'+data.car+'[<font class="text-yellow">'+data.car_type.text+'</font>]汽车，实际贷款金额<font class="text-red">'+Math.floor(data.money/100)+'</font>元，实际垫付给经销商'+data.company+'按揭款 <font class="text-yellow">'+data.advance+'</font>元');
                    $('#paid_time').html(parseInt(data.paid_time) > 0 ? time_to_str_ymd(data.paid_time) : '<font class="text-yellow">未打款</font>');
                    
                    for(var i in data.attach) {
                        var attach = parseFileUrl(INIT.SOURCE_HOST + data.attach[i]);
                        attach.download_url = INIT.API_HOST +'/file/download?token='+token+'&file_id='+attach.fid+'&download_name='+data.bill_sn+'_'+data.name+'_'+Math.floor(data.money/100)+'_'+(parseInt(i)+1)+'.zip';
                        attach.delete = false;
                        $('#attach').fileupload('option', 'done').call($('#attach')[0], $.Event('done'), {result: {error_no:200,result:attach}});
                    }
                    var payment_certificate = parseFileUrl(INIT.SOURCE_HOST + data.payment_certificate);
                    payment_certificate.delete = false;
                    $('#payment_certificate').fileupload('option', 'done').call($('#payment_certificate')[0], $.Event('done'), {result: {error_no:200,result: payment_certificate}});
                    if (data.status.id == 5) {
                        $('.box-footer:eq(0)').removeClass('hide');
                        $('.box-footer:eq(1)').addClass('hide');
                    } else if (data.status.id == 4) {
                        $('#attach .fileupload-buttonbar').hide();
                        $('.box-footer:eq(0)').addClass('hide');
                        $('.box-footer:eq(1)').removeClass('hide');
                        $('.box-footer:eq(1)').find('a:eq(0)').attr('href','borrow_edit.html?bill_id=' + data.finance_bill_id);
                    } else {
                        $('#attach .fileupload-buttonbar').hide();
                        $('.box-footer:eq(0)').addClass('hide');
                        $('.box-footer:eq(1)').addClass('hide');
                    }
                }
                var show_actions = function(lists) {
                    var timeline = $('.timeline');
                    timeline.empty();
                    var c_date = function(str) {
                        return '<li class="time-label"><span class="bg-red">' + str + '</span></li>'
                    }
                    var c_text = function(row){
                        var li = ''
                        li += '<li>'
                        li += '<i class="fa fa-user bg-blue"></i>'

                        li += '<div class="timeline-item">'
                        li += '<span class="time"><i class="fa fa-clock-o"></i> '+time_to_str(parseInt(row.create_time))+'</span>'

                        li += '<h3 class="timeline-header"><a href="javascript:;">'+(row.realname||'') +'</a> '+(row.title||'') +'</h3>'

                        li += '<div class="timeline-body">'
                        li += ''+(row.msg||'') +''
                        li += '</div>'
                        li += '</div>'
                        li += '</li>'
                        return li;
                    }
                    var c_pic = function(row) {
                        var li = '';
                        li += '<li>'
                        li += '<i class="fa fa-user bg-blue"></i>'
                        li += '<div class="timeline-item">'
                        li += '<span class="time"><i class="fa fa-clock-o"></i> 12:05</span>'
                        li += '<h3 class="timeline-header"><a href="#">Support Team</a> 补充照片</h3>'
                        li += '<div class="timeline-body">'
                        li += '<img src="http://placehold.it/150x100" alt="..." class="margin">'
                        li += '<img src="http://placehold.it/150x100" alt="..." class="margin">'
                        li += '<img src="http://placehold.it/150x100" alt="..." class="margin">'
                        li += '<img src="http://placehold.it/150x100" alt="..." class="margin">'
                        li += '</div>'
                        li += '</div>'
                        li += '</li>'
                        return li;
                    }
                    var c_end = function () {
                        return '<li><i class="fa fa-clock-o bg-gray"></i></li>';
                    }
                    var ds = {};
                    for(var i in lists){
                        var date = new Date(parseInt(lists[i]['create_time'])*1000);
                        var ymd = date.getFullYear() + '/' + (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '/' + date.getDate();
                        if (!ds[ymd]) {
                            ds[ymd] = true;
                            timeline.append(c_date(ymd));
                        }
                        timeline.append(c_text(lists[i]));
                    }
                    timeline.append(c_end());
                }
                if (getUrlParam('bill_id')) {
                    var bill_id = getUrlParam('bill_id');
                    FINANCE_BILL.get({token: token, finance_bill_id: bill_id, callback: function (r) {
                            if (r.error_no == '200') {
                                set_value(r.result);
                            } else {
                                var modal = $('#myModal');
                                modal.find('.modal-body').text('获取信息失败！');
                                modal.modal('show');
                            }
                        }
                    });
                    FINANCE_BILL.action_lists({token: token, finance_bill_id: bill_id, callback: function (r) {
                            if (r.error_no == '200') {
                                show_actions(r.result.rows);
                            } else {
                                var modal = $('#myModal');
                                modal.find('.modal-body').text('获取信息失败！');
                                modal.modal('show');
                            }
                        }
                    });
                    $('button[type="submit"]').click(function () {
                        var attach = [];
                        $('#attach').find('.name>a').each(function (index, obj) {
                            attach.push($(this).attr('href'));
                        });
                        var bill = {
                            'attach': attach.join(','),
                            'has_added':$(this).attr('data-added'),
                        }
                        FINANCE_BILL.update({'bill': bill,finance_bill_id:bill_id, token: token, callback: function (r) {
                                var modal = $('#myModal');
                                if (r.error_no == '200') {
                                    modal.find('.modal-body').text('操作成功！');
                                } else {
                                    modal.find('.modal-body').text(r.error_msg);
                                }
                                modal.modal('show');
                            }});
                    });
                } else {
                    var modal = $('#myModal');
                    modal.find('.modal-body').text('获取编号失败！');
                    modal.modal('show');
                }
                $('#payment_certificate').fileupload({
                    // Uncomment the following to send cross-domain cookies:
                    //xhrFields: {withCredentials: true},
                    url: INIT.API_HOST + '/file/upload/form/',
                    formData:[{'name':'token','value':token},{'name':'type','value':'image'},{'name':'sync_to_upyun','value':1}],
                    autoUpload:true,
                    getFilesFromResponse:function(r){
                        if (r.result.error_no == 200) {
                            var file = r.result.result;
                            file.name = file.fid + '.' + file.suffix;
                            file.type = 'image/' + file.suffix;
                            file.thumbnailUrl = file.thumbnailUrl ? file.thumbnailUrl : file.url;
                            file.size = parseInt(file.size);
                            return [file];
                        } else {
                            return [];
                        }
                    }
                })
                $('#attach').fileupload({
                    // Uncomment the following to send cross-domain cookies:
                    //xhrFields: {withCredentials: true},
                    url: INIT.API_HOST + '/file/upload/form/',
                    formData:[{'name':'token','value':token},{'name':'type','value':'zip'}],
                    autoUpload:true,
                    getFilesFromResponse:function(r){
                        if (r.result.error_no == 200) {
                            var file = r.result.result;
                            file.name = file.fid + '.' + file.suffix;
                            file.type = 'application/' + file.suffix;
                            file.thumbnailUrl = '../../dist/img/rar.png';
                            file.size = parseInt(file.size);
                            return [file];
                        } else {
                            return array();
                        }
                    }
                });
            });
            function view(obj) {
                var v = new Viewer(obj,{
                    navbar:false,
                    title:false,
                    toolbar:false
                });
                v.show();
            }
        </script>
    </body>
</html>